{"version":3,"file":"instance.js","sourceRoot":"","sources":["instance.ts"],"names":[],"mappings":"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","sourcesContent":["import { __myreact_shared__ } from \"@my-react/react\";\n\nimport {\n  getFiberWithDom,\n  LinkTreeList,\n  pendingUpdateFiberList,\n  pendingUpdateFiberListArray,\n  triggerUpdate,\n} from \"@ReactDOM_shared\";\n\nimport { updateAllAsync, updateAllSync } from \"../update\";\n\nimport { append } from \"./append\";\nimport { context } from \"./context\";\nimport { create } from \"./create\";\nimport { effect, layoutEffect } from \"./effect\";\nimport { fallback } from \"./fallback\";\nimport { position } from \"./position\";\nimport { unmount } from \"./unmount\";\nimport { update } from \"./update\";\n\nimport type { MyReactFiberNode, FiberDispatch } from \"@my-react/react\";\n\nconst { safeCallWithFiber } = __myreact_shared__;\n\nexport class ClientDispatch implements FiberDispatch {\n  trigger(_fiber: MyReactFiberNode): void {\n    triggerUpdate(_fiber);\n  }\n  resolveLazy(): boolean {\n    return true;\n  }\n  beginProgressList(): void {\n    pendingUpdateFiberList.current = new LinkTreeList();\n  }\n  endProgressList(): void {\n    if (pendingUpdateFiberList.current?.length) {\n      pendingUpdateFiberListArray.current.push(pendingUpdateFiberList.current);\n    }\n    pendingUpdateFiberList.current = null;\n  }\n  generateUpdateList(_fiber: MyReactFiberNode): void {\n    if (_fiber) {\n      if (pendingUpdateFiberList.current) {\n        if (\n          _fiber.__pendingCreate__ ||\n          _fiber.__pendingUpdate__ ||\n          _fiber.__pendingAppend__ ||\n          _fiber.__pendingContext__ ||\n          _fiber.__pendingPosition__ ||\n          _fiber.__effectQueue__.length ||\n          _fiber.__unmountQueue__.length ||\n          _fiber.__layoutEffectQueue__.length\n        ) {\n          pendingUpdateFiberList.current.append(_fiber, _fiber.fiberIndex);\n        }\n      } else {\n        throw new Error(\"error\");\n      }\n    }\n  }\n  reconcileCommit(_fiber: MyReactFiberNode, _hydrate: boolean, _parentFiberWithDom: MyReactFiberNode): boolean {\n    const _result = safeCallWithFiber({\n      fiber: _fiber,\n      action: () => create(_fiber, _hydrate, _parentFiberWithDom),\n    });\n\n    safeCallWithFiber({\n      fiber: _fiber,\n      action: () => update(_fiber, _result),\n    });\n\n    safeCallWithFiber({\n      fiber: _fiber,\n      action: () => append(_fiber, _parentFiberWithDom),\n    });\n\n    let _final = _hydrate;\n\n    if (_fiber.child) {\n      _final = this.reconcileCommit(_fiber.child, _result, _fiber.dom ? _fiber : _parentFiberWithDom);\n      fallback(_fiber);\n    }\n\n    safeCallWithFiber({ fiber: _fiber, action: () => layoutEffect(_fiber) });\n\n    Promise.resolve().then(() => safeCallWithFiber({ fiber: _fiber, action: () => effect(_fiber) }));\n\n    if (_fiber.sibling) {\n      this.reconcileCommit(_fiber.sibling, _fiber.dom ? _result : _final, _parentFiberWithDom);\n    }\n\n    if (_fiber.dom) {\n      return _result;\n    } else {\n      return _final;\n    }\n  }\n  reconcileCreate(_list: LinkTreeList<MyReactFiberNode>): void {\n    _list.listToFoot((_fiber) => {\n      safeCallWithFiber({\n        fiber: _fiber,\n        action: () => create(_fiber, false, _fiber),\n      });\n\n      safeCallWithFiber({\n        fiber: _fiber,\n        action: () => update(_fiber, false),\n      });\n\n      safeCallWithFiber({\n        fiber: _fiber,\n        action: () => unmount(_fiber),\n      });\n\n      safeCallWithFiber({ fiber: _fiber, action: () => context(_fiber) });\n    });\n  }\n  reconcileUpdate(_list: LinkTreeList<MyReactFiberNode>): void {\n    _list.listToHead((_fiber) => {\n      const _parentFiberWithDom = getFiberWithDom(_fiber.parent, (f) => f.parent) as MyReactFiberNode;\n\n      safeCallWithFiber({\n        fiber: _fiber,\n        action: () => position(_fiber, _parentFiberWithDom),\n      });\n    });\n\n    _list.listToFoot((_fiber) => {\n      const _parentFiberWithDom = getFiberWithDom(_fiber.parent, (f) => f.parent) as MyReactFiberNode;\n\n      safeCallWithFiber({\n        fiber: _fiber,\n        action: () => append(_fiber, _parentFiberWithDom),\n      });\n    });\n\n    _list.reconcile((_fiber) => {\n      safeCallWithFiber({\n        fiber: _fiber,\n        action: () => layoutEffect(_fiber),\n      });\n\n      Promise.resolve().then(() => safeCallWithFiber({ fiber: _fiber, action: () => effect(_fiber) }));\n    });\n  }\n  pendingCreate(_fiber: MyReactFiberNode): void {\n    if (!_fiber.__isTextNode__ && !_fiber.__isPlainNode__ && !_fiber.__isPortal__) return;\n    _fiber.__pendingCreate__ = true;\n  }\n  pendingUpdate(_fiber: MyReactFiberNode): void {\n    if (!_fiber.__isTextNode__ && !_fiber.__isPlainNode__) return;\n    _fiber.__pendingUpdate__ = true;\n  }\n  pendingAppend(_fiber: MyReactFiberNode): void {\n    if (!_fiber.__isTextNode__ && !_fiber.__isPlainNode__) return;\n    _fiber.__pendingAppend__ = true;\n  }\n  pendingContext(_fiber: MyReactFiberNode): void {\n    _fiber.__pendingContext__ = true;\n  }\n  pendingPosition(_fiber: MyReactFiberNode): void {\n    _fiber.__pendingPosition__ = true;\n  }\n  pendingUnmount(_fiber: MyReactFiberNode, _pendingUnmount: MyReactFiberNode | MyReactFiberNode[]): void {\n    _fiber.__unmountQueue__.push(_pendingUnmount);\n  }\n  pendingLayoutEffect(_fiber: MyReactFiberNode, _layoutEffect: () => void): void {\n    _fiber.__layoutEffectQueue__.push(_layoutEffect);\n  }\n  pendingEffect(_fiber: MyReactFiberNode, _effect: () => void): void {\n    _fiber.__effectQueue__.push(_effect);\n  }\n  updateAllSync(): void {\n    updateAllSync();\n  }\n  updateAllAsync(): void {\n    updateAllAsync();\n  }\n}\n"]}