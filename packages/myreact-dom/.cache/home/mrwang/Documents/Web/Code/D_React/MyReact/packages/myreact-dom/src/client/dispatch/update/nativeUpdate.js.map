{"version":3,"file":"nativeUpdate.js","sourceRoot":"","sources":["nativeUpdate.ts"],"names":[],"mappings":"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","sourcesContent":["import { __myreact_internal__ } from \"@my-react/react\";\n\nimport {\n  debugWithDOM,\n  enableHighlight,\n  isEvent,\n  isGone,\n  isHydrateRender,\n  isNew,\n  isProperty,\n  isServerRender,\n  isStyle,\n  IS_UNIT_LESS_NUMBER,\n} from \"@ReactDOM_shared\";\n\nimport { addEventListener, removeEventListener } from \"../event\";\n\nimport { HighLight } from \"./highlight\";\n\nimport type { MyReactFiberNode } from \"@my-react/react\";\n\nconst { isAppMounted } = __myreact_internal__;\n\nexport const nativeUpdate = (fiber: MyReactFiberNode) => {\n  if (!fiber.dom) throw new Error(\"update error, dom not exist\");\n  if (fiber.__isTextNode__) {\n    if (fiber.__vdom__ !== fiber.__prevVdom__) {\n      fiber.dom.textContent = fiber.element as string;\n    }\n  } else {\n    const dom = fiber.dom as HTMLElement;\n    const oldProps = fiber.__prevProps__ || {};\n    const newProps = fiber.__props__ || {};\n    Object.keys(oldProps)\n      .filter(isEvent)\n      .filter((key) => isGone(newProps)(key) || isNew(oldProps, newProps)(key))\n      .forEach((key) => removeEventListener(fiber, dom, key));\n    Object.keys(oldProps)\n      .filter(isProperty)\n      .filter(isGone(newProps))\n      .forEach((key) => {\n        if (key === \"className\") {\n          if (fiber.nameSpace) {\n            dom.removeAttribute(\"class\");\n          } else {\n            dom[key] = \"\";\n          }\n        } else {\n          if (key in dom && !fiber.nameSpace) {\n            (dom as any)[key] = \"\";\n          } else {\n            dom.removeAttribute(key);\n          }\n        }\n      });\n    Object.keys(oldProps)\n      .filter(isStyle)\n      .forEach((styleKey) => {\n        Object.keys((oldProps[styleKey] as Record<string, unknown>) || {})\n          .filter(isGone((newProps[styleKey] as Record<string, unknown>) || {}))\n          .forEach((styleName) => {\n            (dom.style as any)[styleName] = \"\";\n          });\n      });\n    Object.keys(newProps)\n      .filter(isEvent)\n      .filter(isNew(oldProps, newProps))\n      .forEach((key) => addEventListener(fiber, dom, key));\n    Object.keys(newProps)\n      .filter(isProperty)\n      .filter(isNew(oldProps, newProps))\n      .forEach((key) => {\n        if (key === \"className\") {\n          if (fiber.nameSpace) {\n            dom.setAttribute(\"class\", (newProps[key] as string) || \"\");\n          } else {\n            dom[key] = (newProps[key] as string) || \"\";\n          }\n        } else {\n          if (key in dom && !fiber.nameSpace) {\n            if (newProps[key] !== null && newProps[key] !== false && newProps[key] !== undefined) {\n              (dom as any)[key] = newProps[key];\n            } else {\n              (dom as any)[key] = \"\";\n            }\n          } else {\n            if (newProps[key] !== null && newProps[key] !== false && newProps[key] !== undefined) {\n              dom.setAttribute(key, String(newProps[key]));\n            } else {\n              dom.removeAttribute(key);\n            }\n          }\n          if ((key === \"autofocus\" || key === \"autoFocus\") && newProps[key]) {\n            Promise.resolve().then(() => dom.focus());\n          }\n        }\n      });\n    Object.keys(newProps)\n      .filter(isStyle)\n      .forEach((styleKey) => {\n        const typedNewProps = newProps[styleKey] as Record<string, unknown>;\n        const typedOldProps = oldProps[styleKey] as Record<string, unknown>;\n        Object.keys(typedNewProps || {})\n          .filter(isNew(typedOldProps || {}, typedNewProps))\n          .forEach((styleName) => {\n            if (\n              !Object.prototype.hasOwnProperty.call(IS_UNIT_LESS_NUMBER, styleName) &&\n              typeof typedNewProps[styleName] === \"number\"\n            ) {\n              (dom as any)[styleKey][styleName] = `${typedNewProps[styleName]}px`;\n              return;\n            }\n            if (typedNewProps[styleName] !== null && typedNewProps[styleName] !== undefined) {\n              (dom as any)[styleKey][styleName] = typedNewProps[styleName];\n            } else {\n              (dom as any)[styleKey][styleName] = \"\";\n            }\n          });\n      });\n    if (\n      newProps[\"dangerouslySetInnerHTML\"] &&\n      newProps[\"dangerouslySetInnerHTML\"] !== oldProps[\"dangerouslySetInnerHTML\"]\n    ) {\n      const typedProps = newProps[\"dangerouslySetInnerHTML\"] as Record<string, unknown>;\n      dom.innerHTML = typedProps.__html as string;\n    }\n  }\n\n  debugWithDOM(fiber);\n\n  if (\n    isAppMounted.current &&\n    !isHydrateRender.current &&\n    !isServerRender.current &&\n    (enableHighlight.current || (window as any).__highlight__)\n  ) {\n    HighLight.getHighLightInstance().highLight(fiber);\n  }\n};\n"]}