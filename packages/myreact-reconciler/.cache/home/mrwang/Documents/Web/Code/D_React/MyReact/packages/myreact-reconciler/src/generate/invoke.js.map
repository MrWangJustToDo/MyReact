{"version":3,"file":"invoke.js","sourceRoot":"","sources":["invoke.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,aAAa,EAAE,oBAAoB,EAAE,kBAAkB,EAAE,MAAM,iBAAiB,CAAC;AAE1F,OAAO,EAAE,mBAAmB,EAAE,oBAAoB,EAAE,MAAM,cAAc,CAAC;AACzE,OAAO,EAAE,sBAAsB,EAAE,MAAM,UAAU,CAAC;AAElD,OAAO,EAAE,sBAAsB,EAAE,MAAM,YAAY,CAAC;AAa5C,IAAA,oBAAoB,GAAgE,oBAAoB,qBAApF,EAAE,oBAAoB,GAA0C,oBAAoB,qBAA9D,EAAE,mBAAmB,GAAqB,oBAAoB,oBAAzC,EAAE,cAAc,GAAK,oBAAoB,eAAzB,CAA0B;AAEzG,IAAA,eAAe,GAAsB,kBAAkB,gBAAxC,EAAE,eAAe,GAAK,kBAAkB,gBAAvB,CAAwB;AAEhE,MAAM,CAAC,IAAM,cAAc,GAAG,UAAC,KAAuB;IACpD,IAAI,KAAK,CAAC,mBAAmB,EAAE;QAC7B,OAAO,sBAAsB,CAAC,KAAK,EAAE,KAAK,CAAC,mBAAmB,CAAC,CAAC;KACjE;SAAM;QACL,OAAO,sBAAsB,CAAC,KAAK,EAAE,KAAK,CAAC,YAAY,CAAC,CAAC;KAC1D;AACH,CAAC,CAAC;AAEF,IAAM,sBAAsB,GAAG,UAAC,KAAuB;IACrD,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE;QACnB,OAAO,mBAAmB,CAAC,KAAK,CAAC,CAAC;KACnC;SAAM;QACL,OAAO,oBAAoB,CAAC,KAAK,CAAC,CAAC;KACpC;AACH,CAAC,CAAC;AAEF,IAAM,yBAAyB,GAAG,UAAC,KAAuB;IACxD,sBAAsB,CAAC,KAAK,CAAC,CAAC;IAE9B,oBAAoB,CAAC,OAAO,GAAG,CAAC,CAAC;IAEjC,oBAAoB,CAAC,OAAO,GAAG,KAAK,CAAC;IAErC,IAAM,YAAY,GAAG,KAAK,CAAC,OAAyB,CAAC;IAErD,IAAM,QAAQ,GAAI,YAAY,CAAC,IAA0B,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;IAE3E,oBAAoB,CAAC,OAAO,GAAG,IAAI,CAAC;IAEpC,oBAAoB,CAAC,OAAO,GAAG,CAAC,CAAC;IAEjC,KAAK,CAAC,mBAAmB,GAAG,QAAQ,CAAC;IAErC,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;AAC/B,CAAC,CAAC;AAEF,IAAM,iBAAiB,GAAG,UAAC,KAAuB;IAChD,IAAI,KAAK,CAAC,uBAAuB,EAAE;QACjC,OAAO,yBAAyB,CAAC,KAAK,CAAC,CAAC;KACzC;SAAM;QACL,OAAO,sBAAsB,CAAC,KAAK,CAAC,CAAC;KACtC;AACH,CAAC,CAAC;AAEF,IAAM,YAAY,GAAG,UAAC,KAAuB;;IACrC,IAAA,KAAgB,KAAK,CAAC,OAAyB,EAA7C,IAAI,UAAA,EAAE,GAAG,SAAoC,CAAC;IAEtD,IAAM,SAAS,GAAG,IAA+B,CAAC;IAElD,IAAM,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC;IAEhC,IAAI,kBAAkB,GAAG,KAAK,CAAC;IAE/B,IAAM,YAAY,GAAG,OAAO,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,kBAAkB,GAAG,IAAI,CAAC,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC;IAExG,IAAM,gBAAgB,GAAG,MAAA,YAAY,aAAZ,YAAY,uBAAZ,YAAY,CAAE,SAAS,0CAAE,kBAAkB,CAAC;IAErE,IAAI,gBAAgB,EAAE;QACpB,OAAO,sBAAsB,CAAC,KAAK,CAAC,CAAC;KACtC;SAAM;QACL,sBAAsB,CAAC,KAAK,CAAC,CAAC;QAE9B,oBAAoB,CAAC,OAAO,GAAG,CAAC,CAAC;QAEjC,oBAAoB,CAAC,OAAO,GAAG,KAAK,CAAC;QAErC,IAAM,WAAW,GAAG,YAAiC,CAAC;QAEtD,IAAM,QAAQ,GAAG,kBAAkB,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;QAEvG,oBAAoB,CAAC,OAAO,GAAG,IAAI,CAAC;QAEpC,oBAAoB,CAAC,OAAO,GAAG,CAAC,CAAC;QAEjC,KAAK,CAAC,mBAAmB,GAAG,QAAQ,CAAC;QAErC,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;KAC9B;AACH,CAAC,CAAC;AAEF,IAAM,YAAY,GAAG,UAAC,KAAuB;IACnC,IAAA,IAAI,GAAK,KAAK,CAAC,OAAyB,KAApC,CAAqC;IAEjD,IAAM,SAAS,GAAG,IAA+B,CAAC;IAElD,IAAI,SAAS,CAAC,OAAO,KAAK,IAAI,EAAE;QAC9B,IAAM,MAAM,GAAG,SAAS,CAAC,MAA4C,CAAC;QAEtE,KAAK,CAAC,mBAAmB,GAAG,aAAa,CAAC,MAAM,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;QAEnE,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;KAC9B;SAAM,IAAI,SAAS,CAAC,QAAQ,KAAK,KAAK,EAAE;QACvC,IAAI,cAAc,CAAC,OAAO,CAAC,WAAW,EAAE,EAAE;YACxC,SAAS,CAAC,QAAQ,GAAG,IAAI,CAAC;YAC1B,OAAO,CAAC,OAAO,EAAE;iBACd,IAAI,CAAC,cAAM,OAAA,SAAS,CAAC,MAAM,EAAE,EAAlB,CAAkB,CAAC;iBAC9B,IAAI,CAAC,UAAC,EAAE;gBACP,IAAM,MAAM,GAAG,OAAO,EAAE,KAAK,QAAQ,IAAI,OAAO,CAAA,EAAE,aAAF,EAAE,uBAAF,EAAE,CAAE,OAAO,CAAA,KAAK,UAAU,CAAC,CAAC,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;gBAC7F,SAAS,CAAC,OAAO,GAAG,IAAI,CAAC;gBACzB,SAAS,CAAC,QAAQ,GAAG,KAAK,CAAC;gBAC3B,SAAS,CAAC,MAAM,GAAG,MAA4C,CAAC;gBAChE,KAAK,CAAC,MAAM,EAAE,CAAC;YACjB,CAAC,CAAC,CAAC;SACN;KACF;IAED,KAAK,CAAC,mBAAmB,GAAG,KAAK,CAAC,YAAY,CAAC;IAE/C,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;AAC/B,CAAC,CAAC;AAEF,IAAM,kBAAkB,GAAG,UAAC,KAAuB;IACjD,sBAAsB,CAAC,KAAK,CAAC,CAAC;IAExB,IAAA,KAAgB,KAAK,CAAC,OAAyB,EAA7C,IAAI,UAAA,EAAE,GAAG,SAAoC,CAAC;IAEtD,IAAM,SAAS,GAAG,IAAqC,CAAC;IAExD,IAAM,WAAW,GAAG,SAAS,CAAC,MAA2B,CAAC;IAE1D,oBAAoB,CAAC,OAAO,GAAG,CAAC,CAAC;IAEjC,oBAAoB,CAAC,OAAO,GAAG,KAAK,CAAC;IAErC,IAAM,QAAQ,GAAG,WAAW,CAAC,KAAK,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;IAEnD,oBAAoB,CAAC,OAAO,GAAG,IAAI,CAAC;IAEpC,oBAAoB,CAAC,OAAO,GAAG,CAAC,CAAC;IAEjC,KAAK,CAAC,mBAAmB,GAAG,QAAQ,CAAC;IAErC,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;AAC/B,CAAC,CAAC;AAEF,IAAM,gBAAgB,GAAG,UAAC,KAAuB,IAAK,OAAA,cAAc,CAAC,KAAK,CAAC,EAArB,CAAqB,CAAC;AAE5E,IAAM,gBAAgB,GAAG,UAAC,KAAuB;IACzC,IAAA,KAAkB,KAAK,CAAC,OAAyB,EAA/C,IAAI,UAAA,EAAE,KAAK,WAAoC,CAAC;IAExD,IAAM,SAAS,GAAG,IAAoD,CAAC;IAEvE,KAAK,CAAC,QAAQ,GAAG,KAAK,CAAC,QAAQ,IAAI,IAAI,SAAS,CAAC,QAAQ,EAAE,CAAC;IAE5D,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;IAE/B,IAAM,OAAO,GAAG,SAAS,CAAC,OAA2C,CAAC;IAEtE,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,WAAW,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,WAAW,CAAC,KAAK,EAAE;QACpE,IAAM,aAAa,GAAG,eAAe,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;QAEtD,IAAM,OAAO,GAAG,eAAe,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC;QAExD,KAAK,CAAC,QAAQ,CAAC,OAAO,GAAG,OAAO,CAAC;QAEjC,KAAK,CAAC,QAAQ,CAAC,UAAU,CAAC,aAAa,CAAC,CAAC;KAC1C;SAAM;QACL,IAAM,OAAO,GAAG,eAAe,CAAC,KAAK,CAAC,QAAQ,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC;QAErE,KAAK,CAAC,QAAQ,CAAC,OAAO,GAAG,OAAO,CAAC;KAClC;IAED,IAAM,aAAa,GAAG,KAAK,CAAC,QAAwC,CAAC;IAErE,IAAM,QAAQ,GAAG,aAAa,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;IAEvD,KAAK,CAAC,mBAAmB,GAAG,QAAQ,CAAC;IAErC,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;AAC/B,CAAC,CAAC;AAEF,IAAM,cAAc,GAAG,UAAC,KAAuB;IAC7C,IAAI,KAAK,CAAC,UAAU;QAAE,OAAO,YAAY,CAAC,KAAK,CAAC,CAAC;IACjD,IAAI,KAAK,CAAC,UAAU;QAAE,OAAO,YAAY,CAAC,KAAK,CAAC,CAAC;IACjD,IAAI,KAAK,CAAC,YAAY;QAAE,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;IACrD,IAAI,KAAK,CAAC,cAAc;QAAE,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC;IACvD,IAAI,KAAK,CAAC,gBAAgB;QAAE,OAAO,kBAAkB,CAAC,KAAK,CAAC,CAAC;IAC7D,IAAI,KAAK,CAAC,qBAAqB;QAAE,OAAO,gBAAgB,CAAC,KAAK,CAAC,CAAC;IAChE,IAAI,KAAK,CAAC,qBAAqB;QAAE,OAAO,gBAAgB,CAAC,KAAK,CAAC,CAAC;IAChE,MAAM,IAAI,KAAK,CAAC,0BAAmB,KAAK,CAAC,OAAO,CAAE,CAAC,CAAC;AACtD,CAAC,CAAC;AAEF,MAAM,CAAC,IAAM,YAAY,GAAG,UAAC,KAAuB;IAClD,IAAI,CAAC,KAAK,CAAC,KAAK;QAAE,OAAO,EAAE,CAAC;IAE5B,IAAI,CAAC,KAAK,CAAC,cAAc,IAAI,CAAC,KAAK,CAAC,eAAe;QAAE,OAAO,EAAE,CAAC;IAE/D,mBAAmB,CAAC,OAAO,GAAG,KAAK,CAAC;IAEpC,IAAI,QAAQ,GAAuB,EAAE,CAAC;IAEtC,IAAI,KAAK,CAAC,iBAAiB;QAAE,QAAQ,GAAG,iBAAiB,CAAC,KAAK,CAAC,CAAC;SAC5D,IAAI,KAAK,CAAC,gBAAgB;QAAE,QAAQ,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;;QAC7D,QAAQ,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;IAEtC,mBAAmB,CAAC,OAAO,GAAG,IAAI,CAAC;IAEnC,OAAO,QAAQ,CAAC;AAClB,CAAC,CAAC;AAEF,MAAM,CAAC,IAAM,aAAa,GAAG,UAAC,KAAuB,EAAE,aAAsC;IAC3F,IAAI,CAAC,KAAK,CAAC,KAAK;QAAE,OAAO,IAAI,CAAC;IAE9B,IAAI,KAAK,CAAC,cAAc,IAAI,KAAK,CAAC,eAAe,EAAE;QACjD,mBAAmB,CAAC,OAAO,GAAG,KAAK,CAAC;QAEpC,IAAI,KAAK,CAAC,iBAAiB;YAAE,iBAAiB,CAAC,KAAK,CAAC,CAAC;aACjD,IAAI,KAAK,CAAC,gBAAgB;YAAE,cAAc,CAAC,KAAK,CAAC,CAAC;;YAClD,cAAc,CAAC,KAAK,CAAC,CAAC;QAE3B,mBAAmB,CAAC,OAAO,GAAG,IAAI,CAAC;QAEnC,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,EAAE;YACzB,OAAO,KAAK,CAAC,KAAK,CAAC;SACpB;KACF;IAED,IAAI,SAAS,GAA4B,KAAK,CAAC;IAE/C,OAAO,SAAS,IAAI,SAAS,KAAK,aAAa,EAAE;QAC/C,IAAI,SAAS,CAAC,OAAO,EAAE;YACrB,OAAO,SAAS,CAAC,OAAO,CAAC;SAC1B;QACD,SAAS,GAAG,SAAS,CAAC,MAAM,CAAC;KAC9B;IAED,OAAO,IAAI,CAAC;AACd,CAAC,CAAC","sourcesContent":["import { createElement, __myreact_internal__, __myreact_shared__ } from \"@my-react/react\";\n\nimport { classComponentMount, classComponentUpdate } from \"../component\";\nimport { processHookUpdateQueue } from \"../queue\";\n\nimport { transformChildrenFiber } from \"./generate\";\n\nimport type {\n  MyReactFiberNode,\n  MyReactElement,\n  FunctionComponent,\n  memo,\n  lazy,\n  ClassComponent,\n  createContext,\n  forwardRef,\n} from \"@my-react/react\";\n\nconst { currentHookDeepIndex, currentFunctionFiber, currentRunningFiber, globalDispatch } = __myreact_internal__;\n\nconst { getContextFiber, getContextValue } = __myreact_shared__;\n\nexport const nextWorkCommon = (fiber: MyReactFiberNode) => {\n  if (fiber.__isRenderDynamic__) {\n    return transformChildrenFiber(fiber, fiber.__dynamicChildren__);\n  } else {\n    return transformChildrenFiber(fiber, fiber.__children__);\n  }\n};\n\nconst nextWorkClassComponent = (fiber: MyReactFiberNode) => {\n  if (!fiber.instance) {\n    return classComponentMount(fiber);\n  } else {\n    return classComponentUpdate(fiber);\n  }\n};\n\nconst nextWorkFunctionComponent = (fiber: MyReactFiberNode) => {\n  processHookUpdateQueue(fiber);\n\n  currentHookDeepIndex.current = 0;\n\n  currentFunctionFiber.current = fiber;\n\n  const typedElement = fiber.element as MyReactElement;\n\n  const children = (typedElement.type as FunctionComponent)(fiber.__props__);\n\n  currentFunctionFiber.current = null;\n\n  currentHookDeepIndex.current = 0;\n\n  fiber.__dynamicChildren__ = children;\n\n  return nextWorkCommon(fiber);\n};\n\nconst nextWorkComponent = (fiber: MyReactFiberNode) => {\n  if (fiber.__isFunctionComponent__) {\n    return nextWorkFunctionComponent(fiber);\n  } else {\n    return nextWorkClassComponent(fiber);\n  }\n};\n\nconst nextWorkMemo = (fiber: MyReactFiberNode) => {\n  const { type, ref } = fiber.element as MyReactElement;\n\n  const typedType = type as ReturnType<typeof memo>;\n\n  const render = typedType.render;\n\n  let isForwardRefRender = false;\n\n  const targetRender = typeof render === \"object\" ? ((isForwardRefRender = true), render.render) : render;\n\n  const isClassComponent = targetRender?.prototype?.isMyReactComponent;\n\n  if (isClassComponent) {\n    return nextWorkClassComponent(fiber);\n  } else {\n    processHookUpdateQueue(fiber);\n\n    currentHookDeepIndex.current = 0;\n\n    currentFunctionFiber.current = fiber;\n\n    const typedRender = targetRender as FunctionComponent;\n\n    const children = isForwardRefRender ? typedRender(fiber.__props__, ref) : typedRender(fiber.__props__);\n\n    currentFunctionFiber.current = null;\n\n    currentHookDeepIndex.current = 0;\n\n    fiber.__dynamicChildren__ = children;\n\n    return nextWorkCommon(fiber);\n  }\n};\n\nconst nextWorkLazy = (fiber: MyReactFiberNode) => {\n  const { type } = fiber.element as MyReactElement;\n\n  const typedType = type as ReturnType<typeof lazy>;\n\n  if (typedType._loaded === true) {\n    const render = typedType.render as ClassComponent | FunctionComponent;\n\n    fiber.__dynamicChildren__ = createElement(render, fiber.__props__);\n\n    return nextWorkCommon(fiber);\n  } else if (typedType._loading === false) {\n    if (globalDispatch.current.resolveLazy()) {\n      typedType._loading = true;\n      Promise.resolve()\n        .then(() => typedType.loader())\n        .then((re) => {\n          const render = typeof re === \"object\" && typeof re?.default === \"function\" ? re.default : re;\n          typedType._loaded = true;\n          typedType._loading = false;\n          typedType.render = render as ClassComponent | FunctionComponent;\n          fiber.update();\n        });\n    }\n  }\n\n  fiber.__dynamicChildren__ = fiber.__fallback__;\n\n  return nextWorkCommon(fiber);\n};\n\nconst nextWorkForwardRef = (fiber: MyReactFiberNode) => {\n  processHookUpdateQueue(fiber);\n\n  const { type, ref } = fiber.element as MyReactElement;\n\n  const typedType = type as ReturnType<typeof forwardRef>;\n\n  const typedRender = typedType.render as FunctionComponent;\n\n  currentHookDeepIndex.current = 0;\n\n  currentFunctionFiber.current = fiber;\n\n  const children = typedRender(fiber.__props__, ref);\n\n  currentFunctionFiber.current = null;\n\n  currentHookDeepIndex.current = 0;\n\n  fiber.__dynamicChildren__ = children;\n\n  return nextWorkCommon(fiber);\n};\n\nconst nextWorkProvider = (fiber: MyReactFiberNode) => nextWorkCommon(fiber);\n\nconst nextWorkConsumer = (fiber: MyReactFiberNode) => {\n  const { type, props } = fiber.element as MyReactElement;\n\n  const typedType = type as ReturnType<typeof createContext>[\"Consumer\"];\n\n  fiber.instance = fiber.instance || new typedType.Internal();\n\n  fiber.instance.setFiber(fiber);\n\n  const Context = typedType.Context as ReturnType<typeof createContext>;\n\n  if (!fiber.instance.__context__ || !fiber.instance.__context__.mount) {\n    const ProviderFiber = getContextFiber(fiber, Context);\n\n    const context = getContextValue(ProviderFiber, Context);\n\n    fiber.instance.context = context;\n\n    fiber.instance.setContext(ProviderFiber);\n  } else {\n    const context = getContextValue(fiber.instance.__context__, Context);\n\n    fiber.instance.context = context;\n  }\n\n  const typedChildren = props.children as unknown as FunctionComponent;\n\n  const children = typedChildren(fiber.instance.context);\n\n  fiber.__dynamicChildren__ = children;\n\n  return nextWorkCommon(fiber);\n};\n\nconst nextWorkObject = (fiber: MyReactFiberNode) => {\n  if (fiber.__isMemo__) return nextWorkMemo(fiber);\n  if (fiber.__isLazy__) return nextWorkLazy(fiber);\n  if (fiber.__isPortal__) return nextWorkCommon(fiber);\n  if (fiber.__isSuspense__) return nextWorkCommon(fiber);\n  if (fiber.__isForwardRef__) return nextWorkForwardRef(fiber);\n  if (fiber.__isContextProvider__) return nextWorkProvider(fiber);\n  if (fiber.__isContextConsumer__) return nextWorkConsumer(fiber);\n  throw new Error(`unknown element ${fiber.element}`);\n};\n\nexport const nextWorkSync = (fiber: MyReactFiberNode) => {\n  if (!fiber.mount) return [];\n\n  if (!fiber.__needUpdate__ && !fiber.__needTrigger__) return [];\n\n  currentRunningFiber.current = fiber;\n\n  let children: MyReactFiberNode[] = [];\n\n  if (fiber.__isDynamicNode__) children = nextWorkComponent(fiber);\n  else if (fiber.__isObjectNode__) children = nextWorkObject(fiber);\n  else children = nextWorkCommon(fiber);\n\n  currentRunningFiber.current = null;\n\n  return children;\n};\n\nexport const nextWorkAsync = (fiber: MyReactFiberNode, topLevelFiber: MyReactFiberNode | null) => {\n  if (!fiber.mount) return null;\n\n  if (fiber.__needUpdate__ || fiber.__needTrigger__) {\n    currentRunningFiber.current = fiber;\n\n    if (fiber.__isDynamicNode__) nextWorkComponent(fiber);\n    else if (fiber.__isObjectNode__) nextWorkObject(fiber);\n    else nextWorkCommon(fiber);\n\n    currentRunningFiber.current = null;\n\n    if (fiber.children.length) {\n      return fiber.child;\n    }\n  }\n\n  let nextFiber: MyReactFiberNode | null = fiber;\n\n  while (nextFiber && nextFiber !== topLevelFiber) {\n    if (nextFiber.sibling) {\n      return nextFiber.sibling;\n    }\n    nextFiber = nextFiber.parent;\n  }\n\n  return null;\n};\n"]}