{"version":3,"file":"instance.js","sourceRoot":"","sources":["instance.ts"],"names":[],"mappings":"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","sourcesContent":["import { getContextFiber, getContextValue } from \"../fiber\";\nimport { MyReactInternalInstance } from \"../internal\";\nimport { isArrayEquals } from \"../share\";\n\nimport type { HookUpdateQueue } from \"../fiber\";\n\nexport type HOOK_TYPE =\n  | \"useRef\"\n  | \"useMemo\"\n  | \"useState\"\n  | \"useEffect\"\n  | \"useContext\"\n  | \"useReducer\"\n  | \"useCallback\"\n  | \"useDebugValue\"\n  | \"useLayoutEffect\"\n  | \"useImperativeHandle\";\n\nexport type Action = (s: any) => any | { type: string; payload: any };\n\nexport type Reducer = (state?: any, action?: Action) => any;\n\nexport class MyReactHookNode extends MyReactInternalInstance {\n  hookIndex = 0;\n\n  hookNext: MyReactHookNode | null = null;\n\n  hookPrev: MyReactHookNode | null = null;\n\n  hookType: HOOK_TYPE | null = null;\n\n  cancel: (() => void) | null = null;\n\n  effect = false;\n\n  value: any = null;\n\n  reducer: Reducer;\n\n  deps: any[] = [];\n\n  result: any = null;\n\n  constructor(hookIndex: number, hookType: HOOK_TYPE, value: any, reducer: Reducer, deps: any[]) {\n    super();\n    this.deps = deps;\n    this.value = value;\n    this.reducer = reducer;\n    this.hookType = hookType;\n    this.hookIndex = hookIndex;\n  }\n\n  initialResult() {\n    if (this.hookType === \"useMemo\" || this.hookType === \"useState\" || this.hookType === \"useReducer\") {\n      this.result = this.value.call(null);\n      return;\n    }\n\n    if (\n      this.hookType === \"useEffect\" ||\n      this.hookType === \"useLayoutEffect\" ||\n      this.hookType === \"useImperativeHandle\"\n    ) {\n      this.effect = true;\n      return;\n    }\n\n    if (this.hookType === \"useRef\" || this.hookType === \"useCallback\") {\n      this.result = this.value;\n      return;\n    }\n\n    if (this.hookType === \"useContext\") {\n      const ProviderFiber = getContextFiber(this.__fiber__, this.value);\n      this.setContext(ProviderFiber);\n      this.result = getContextValue(ProviderFiber, this.value);\n      this.context = this.result;\n      return;\n    }\n  }\n\n  updateResult(newValue: any, newReducer: Reducer, newDeps: any[]) {\n    if (\n      this.hookType === \"useMemo\" ||\n      this.hookType === \"useEffect\" ||\n      this.hookType === \"useCallback\" ||\n      this.hookType === \"useLayoutEffect\" ||\n      this.hookType === \"useImperativeHandle\"\n    ) {\n      if (newDeps && !this.deps) {\n        throw new Error(\"deps state change\");\n      }\n      if (!newDeps && this.deps) {\n        throw new Error(\"deps state change\");\n      }\n    }\n\n    if (\n      this.hookType === \"useEffect\" ||\n      this.hookType === \"useLayoutEffect\" ||\n      this.hookType === \"useImperativeHandle\"\n    ) {\n      if (!newDeps) {\n        this.value = newValue;\n        this.reducer = newReducer || this.reducer;\n        this.deps = newDeps;\n        this.effect = true;\n      } else if (!isArrayEquals(this.deps, newDeps)) {\n        this.value = newValue;\n        this.reducer = newReducer || this.reducer;\n        this.deps = newDeps;\n        this.effect = true;\n      }\n      return;\n    }\n\n    if (this.hookType === \"useCallback\") {\n      if (!isArrayEquals(this.deps, newDeps)) {\n        this.value = newValue;\n        this.result = newValue;\n        this.deps = newDeps;\n      }\n      return;\n    }\n\n    if (this.hookType === \"useMemo\") {\n      if (!isArrayEquals(this.deps, newDeps)) {\n        this.value = newValue;\n        this.result = newValue.call(null);\n        this.deps = newDeps;\n      }\n      return;\n    }\n\n    if (this.hookType === \"useContext\") {\n      if (!this.__context__ || !this.__context__.mount || !Object.is(this.value, newValue)) {\n        this.value = newValue;\n        const ProviderFiber = getContextFiber(this.__fiber__, this.value);\n        this.setContext(ProviderFiber);\n        this.result = getContextValue(ProviderFiber, this.value);\n        this.context = this.result;\n      } else {\n        this.result = getContextValue(this.__context__, this.value);\n        this.context = this.result;\n      }\n      return;\n    }\n\n    if (this.hookType === \"useReducer\") {\n      this.value = newValue;\n      this.reducer = newReducer;\n    }\n  }\n\n  unmount() {\n    if (this.hookType === \"useEffect\" || this.hookType === \"useLayoutEffect\") {\n      this.effect = false;\n      this.cancel && this.cancel();\n      return;\n    }\n    if (this.hookType === \"useContext\") {\n      this.__context__?.removeDependence(this);\n    }\n  }\n\n  dispatch = (action: Action) => {\n    const updater: HookUpdateQueue = {\n      type: \"hook\",\n      trigger: this,\n      action,\n    };\n\n    this.__fiber__?.__hookUpdateQueue__.push(updater);\n\n    Promise.resolve().then(() => {\n      this.__fiber__?.update();\n    });\n  };\n}\n"]}